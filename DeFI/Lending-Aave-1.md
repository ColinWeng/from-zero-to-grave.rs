

# 一、最核心：借贷底层机制（用户视角 + 合约视角双解析）

Aave V3 的一切功能都围绕 “去中心化借贷” 展开，核心逻辑是 “用户存款提供流动性→获取利息凭证（aToken）→其他用户以超额抵押方式借款→借款利息分给存款人 + 协议抽成”，底层依赖 “资产池 + 凭证化 + 秒级计息” 实现，以下是 step-by-step 拆解：

## 第一步：用户存款（流动性注入的核心流程）​

用户存入资产（如 USDC）是借贷的基础，核心是 “**资产入池 + 凭证发放 + 自动计息**”：

- **用户操作**：在 Aave 前端授权 USDC 转账，输入存款金额（如 10,000 USDC），点击 “Deposit”；

- **合约交互流程**：
   1. 用户钱包调用 `LendingPool.deposit` 函数，传入资产地址（USDC）、金额、接收地址（自己）、 referralCode（0 为默认）；
   1. 合约先验证 `用户授权额度 ≥ 存款金额`，扣划用户钱包内的 USDC 转入 Aave 资产池（`LendingPoolCore` 合约）；
   1. 触发 `InterestRateStrategy` 合约更新当前资产的**共享指数**（`liquidityIndex`），确保计息起点精准；
   1. 计算用户应得的 aToken 数量：`aToken数量 = 存款金额 ÷ 当前liquidityIndex`（如 index=1.0 时，10,000 USDC 对应 10,000 aUSDC）；
   1. `AToken` 合约铸造对应数量的 aUSDC 给用户，aToken 是 “利息累积型凭证”，余额会随 `liquidityIndex`增长自动增加（无需用户手动领取利息）。


- **关键细节**：

  - aToken 本质是 ERC20 代币，但自带 “利息自动复利” 属性，用户持有 aToken 即等同于在资产池内享受存款利息；

  - 示例：存款 10,000 USDC 后 30 天，`liquidityIndex` 涨到 1.003288，用户的 aUSDC 余额自动变为 10,000×1.003288=10,032.88，对应 32.88 USDC 利息。


## 第二步：用户借款（超额抵押的核心逻辑）

用户借款的前提是 “存入抵押品”，核心是 “**抵押品估值→借款额度计算→债务凭证生成**”：

- **用户操作**：存入 ETH 作为抵押品（如 1 ETH），选择借款资产（USDC）、借款类型（浮动利率），输入借款金额（如 2,000 USDC），点击 “Borrow”；

- **合约交互流程**：
  1. 先验证抵押品：用户已存入的 ETH 对应的 aETH 被锁定为抵押品（不可直接转账，需还款后解锁）；
  1. 价格估值：`RiskManager` 合约通过 Chainlink 预言机获取实时价格（如 ETH=2,500 USDC），计算抵押品价值 = 1×2,500=2,500 USDC；
  1. 借款额度计算：根据 ETH 的 LTV 参数（如 80%），最大可借款额度 = 2,500×80%=2,000 USDC（用户刚好借满上限）；
  1. 健康因子（HF）校验：HF=（抵押品价值 × 清算阈值）÷ 借款价值，ETH 清算阈值 = 82%，则 HF=（2,500×82%）÷2,000=1.025＞1，满足借款条件；
  1. 计息准备：更新 USDC 的债务指数（`variableBorrowIndex`），计算用户的专属债务缩放值：`scaledVariableDebt=2,000 ÷ 当前variableBorrowIndex`（如 index=1.0 时，缩放值 = 2,000）；
  1. 资金发放：从 USDC 资产池划转 2,000 USDC 到用户钱包，同时 `DebtToken` 合约记录用户的债务缩放值（后续计息的核心依据）。


- **关键约束**：


  - 借款后 HF 必须≥1，否则无法借款；若后续抵押品价格下跌导致 HF＜1，会触发清算；

  - 浮动利率借款的利息，通过 variableBorrowIndex 秒级累积，用户无需手动计息，还款时一次性结算。


  


## 第三步：计息过程（核心中的核心：共享指数 + 个人缩放值）

这是 Aave V3 最关键的机制，解决 “**动态利率 + 秒级复利 + 公平性**” 问题，之前的疑问都集中在这里：

- **核心逻辑**：存款利息和借款利息都通过 “共享指数” 累积，个人仅需持有 “固定缩放值”，无需单独更新余额；

- **存款计息（aToken 增值）**：

  - 触发条件：任何用户对该资产执行 “存 / 借 / 还 / 清算” 操作时，都会触发 `liquidityIndex` 更新；

  - 更新公式：`新liquidityIndex = 旧index × (1 + 存款利率 × 时间间隔/365)`；

  - 示例：USDC 存款利率 = 2.6875%，上次更新时间是 10 天前，旧 index=1.0，则新 index=1.0×(1+2.6875%×10/365)=1.000736；

  - 用户收益：存款用户的 aUSDC 余额 = 个人缩放值 × 新 index，自动实现复利（如缩放值 = 10,000，余额变为 10,000×1.000736=10,007.36，利息 7.36 USDC）。

- **借款计息（债务累积）**：

  - 触发条件：与存款指数更新同步，任何 USDC 相关操作都会更新 `variableBorrowIndex`；`

  - 更新公式：`新variableBorrowIndex = 旧index × (1 + 浮动借款利率 × 时间间隔/365)`；

  - 示例：USDC 浮动借款利率 = 2.6875%，10 天后 index 从 1.0 涨到 1.000736；

  - 用户债务：总负债 = 个人缩放值 × 新 index（如缩放值 = 2,000，总负债 = 2,000×1.000736=2,001.47 USDC，利息 1.47 USDC）。

- **为什么要这么设计？**

  - 避免高频更新：若每个用户单独记录余额，1 万用户需更新 1 万次，Gas 费爆炸；共享指数仅更新 1 次，所有用户自动同步；

  - 公平性保障：无论用户何时存款 / 借款，都按 “自己操作后的指数增量” 计息，不会多算或少算（如中间借款用户的缩放值已锁定起点）。


  


## 第四步：用户还款 + 提现（流程闭环）

- **还款操作**：用户归还 2,001.47 USDC（本金 + 利息），点击 “Repay”；
  - 合约流程：扣划用户钱包的 USDC，先结算当前 `variableBorrowIndex `对应的总负债，核销用户的 `scaledVariableDebt`（变为 0），解锁抵押的 aETH；

- **提现操作**：用户点击 “Withdraw” 提取 10,007.36 aUSDC（含利息）；
  - 合约流程：销毁用户的 aUSDC，从资产池划转 10,007.36 USDC 到用户钱包，完成整个借贷闭环。





